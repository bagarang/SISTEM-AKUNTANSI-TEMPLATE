<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UMKM ERP Ultimate - Final Stable v37</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        /* --- 1. MODERN VARIABLES --- */
        :root {
            --primary-grad: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --accent-grad: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --success-grad: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-grad: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --primary: #0f172a; --accent: #2563eb; --success: #10b981; --danger: #ef4444;
            --bg: #f1f5f9; --surface: #ffffff; --text: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --radius-lg: 20px; --radius-md: 12px;
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        /* --- 2. RESET & BASE --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        /* --- 3. UI COMPONENTS --- */
        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .font-bold { font-weight: 700; } .text-center { text-align: center; }
        .p-4 { padding: 1.25rem; } .mb-4 { margin-bottom: 1rem; } .w-full { width: 100%; }

        .btn { padding: 14px 20px; border-radius: var(--radius-md); border: none; font-weight: 700; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 10px; font-size: 0.95rem; justify-content: center; color: white; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent-grad); box-shadow: 0 4px 14px rgba(37,99,235,0.3); }
        .btn-success { background: var(--success-grad); box-shadow: 0 4px 14px rgba(16,185,129,0.3); }
        .btn-danger { background: var(--danger-grad); box-shadow: 0 4px 14px rgba(239,68,68,0.3); }
        .btn-ghost { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        
        .card { background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .form-control { width:100%; padding:14px; border:2px solid var(--border); border-radius: var(--radius-md); font-size: 1rem; background: var(--surface); transition: 0.3s; }
        .form-control:focus { border-color: var(--accent); }

        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: var(--radius-md); border: 1px solid var(--border); }
        table { width:100%; border-collapse:collapse; white-space: nowrap; }
        th { text-align:left; padding:16px; background: #f8fafc; color:var(--text-muted); border-bottom: 1px solid var(--border); }
        td { padding:16px; border-bottom:1px solid var(--border); }

        .badge { padding: 6px 12px; border-radius: 99px; font-size: 0.75rem; font-weight: 800; }
        .badge-off { background: #e0f2fe; color: #0369a1; }
        .badge-on { background: #dcfce7; color: #15803d; }

        .tab-btn { padding: 10px 20px; border-radius: 10px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 600; color: var(--text-muted); }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- 4. LAYOUT --- */
        #app-main { display:none; height:100vh; width: 100%; display: flex; overflow: hidden; }
        aside { width: 280px; background: var(--primary-grad); display:flex; flex-direction:column; z-index:1000; transition: 0.4s; }
        .nav-item { padding:14px 20px; border-radius: var(--radius-md); margin: 4px 12px; cursor:pointer; display:flex; align-items:center; gap:14px; color: rgba(255,255,255,0.7); font-weight: 500; }
        .nav-item.active { background: var(--accent-grad); color: white; }
        
        main { flex:1; display:flex; flex-direction:column; overflow:hidden; background: var(--bg); position: relative; }
        header { height:75px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 25px; justify-content:space-between; flex-shrink: 0; }
        .content { flex:1; overflow-y:auto; padding:20px; -webkit-overflow-scrolling: touch; }

        /* --- 5. POS & GRID --- */
        .pos-layout { display: flex; gap: 20px; height: 100%; }
        .pos-main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .pos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; overflow-y: auto; padding-bottom: 20px; }
        .product { border: 1px solid var(--border); border-radius: var(--radius-lg); overflow:hidden; cursor:pointer; background:white; transition: 0.2s; }
        .p-img { height:110px; background:#f1f5f9; object-fit:cover; width:100%; border-bottom:1px solid var(--border); }
        .p-body { padding:12px; }

        .cart-panel { width: 350px; background: white; border-radius: var(--radius-lg); border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; padding: 20px; box-shadow: var(--shadow-md); }

        /* --- 6. OVERLAYS --- */
        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:5000; backdrop-filter:blur(8px); padding:20px; }
        .toast { position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background: var(--primary); color:white; padding:15px 30px; border-radius:50px; z-index:99999; font-weight: 600; opacity:0; transition: 0.4s; pointer-events:none; }
        .toast.show { opacity:1; }

        #loading-screen { position: fixed; inset:0; background: var(--primary-grad); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; }
        .spinner { width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media print { body * { visibility: hidden; } #thermal-receipt, #thermal-receipt * { visibility: visible; } #thermal-receipt { position: fixed; left: 0; top: 0; width: 58mm; display: block !important; } }
    </style>
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <h2 style="margin-top:20px;">UMKM ERP ULTIMATE</h2>
    </div>

    <div id="login-screen" style="position: fixed; inset:0; background:var(--bg); z-index:9998; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center; padding: 40px;">
            <div style="margin-bottom: 20px;"><img src="https://cdn-icons-png.flaticon.com/512/6195/6195699.png" style="width:60px;"></div>
            <h2 class="mb-4">Login Sistem</h2>
            <div style="background:#f1f5f9; padding:20px; border-radius:20px; font-family:'Roboto Mono'; font-size:2.5rem; color:var(--accent); margin-bottom:25px; border:2px solid var(--border); height:85px; display:flex; align-items:center; justify-content:center;" id="pin-display"></div>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <button class="btn btn-ghost" onclick="Login.input(1)">1</button><button class="btn btn-ghost" onclick="Login.input(2)">2</button><button class="btn btn-ghost" onclick="Login.input(3)">3</button>
                <button class="btn btn-ghost" onclick="Login.input(4)">4</button><button class="btn btn-ghost" onclick="Login.input(5)">5</button><button class="btn btn-ghost" onclick="Login.input(6)">6</button>
                <button class="btn btn-ghost" onclick="Login.input(7)">7</button><button class="btn btn-ghost" onclick="Login.input(8)">8</button><button class="btn btn-ghost" onclick="Login.input(9)">9</button>
                <button class="btn btn-danger" onclick="Login.clear()">C</button><button class="btn btn-ghost" onclick="Login.input(0)">0</button>
                <button class="btn btn-primary" onclick="Login.submit()">OK</button>
            </div>
        </div>
    </div>

    <div id="app-main">
        <aside id="sidebar">
            <div style="padding:30px; text-align:center;"><h2 style="color:white; font-weight:800; margin:0;">UMKM ERP.</h2></div>
            <nav style="flex:1; overflow-y:auto;">
                <a class="nav-item hidden" id="nav-dashboard" onclick="Router.go('dashboard')"><span>üìä</span> <span>Dashboard</span></a>
                <a class="nav-item" id="nav-pos" onclick="Router.go('pos')"><span>üõí</span> <span>Kasir Toko</span></a>
                <a class="nav-item" id="nav-online" onclick="Router.go('online')"><span>üì±</span> <span>Order WA</span></a>
                <a class="nav-item hidden" id="nav-sales" onclick="Router.go('sales')"><span>üìà</span> <span>Log Penjualan</span></a>
                <a class="nav-item hidden" id="nav-expenses" onclick="Router.go('expenses')"><span>üìâ</span> <span>Log Pengeluaran</span></a>
                <a class="nav-item" id="nav-supply" onclick="Router.go('supply')"><span>üöö</span> <span>Gudang & Ops</span></a>
                <a class="nav-item hidden" id="nav-inventory" onclick="Router.go('inventory')"><span>üì¶</span> <span>Stok Barang</span></a>
                <a class="nav-item hidden" id="nav-finance" onclick="Router.go('finance')"><span>üìÑ</span> <span>Laporan L/R</span></a>
                <a class="nav-item hidden" id="nav-employees" onclick="Router.go('employees')"><span>üë•</span> <span>Tim</span></a>
            </nav>
            <div style="padding:20px;"><button class="btn btn-danger w-full" onclick="location.reload()">Log Out</button></div>
        </aside>

        <main>
            <header>
                <button class="btn btn-ghost" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
                <div id="page-title" class="font-bold">DASHBOARD</div>
                <div id="date-display" class="hidden md:block"></div>
            </header>
            <div id="content" class="content"></div>
        </main>
    </div>

    <div id="thermal-receipt" style="display:none; font-family:'Roboto Mono'; font-size:11px; color:black; padding:2mm;">
        <div style="text-align:center;">
            <h3 id="r-shop-name">TOKO</h3>
            <p id="r-shop-addr" style="font-size:9px;"></p>
            <hr style="border:0.5px dashed black;">
        </div>
        <div id="r-items" style="margin:10px 0;"></div>
        <hr style="border:0.5px dashed black;">
        <div class="flex justify-between"><b>TOTAL</b><b id="r-total"></b></div>
        <p style="text-align:center; margin-top:15px;">TERIMA KASIH</p>
    </div>

    <script>
        const APP_SETTINGS = { shopName: "UMKM ELITE POS", shopAddress: "Digital District No. 101" };

        const DB = {
            data: { products: [], transactions: [], purchases: [], employees: [], waOrders: [] },
            init() {
                const store = localStorage.getItem('umkm_erp_v37');
                if(store) this.data = JSON.parse(store);
                else {
                    this.data.products = [ 
                        { id:1, name:'Produk A', price:20000, hpp:8000, stock:50, type:'finished' }, 
                        { id:2, name:'Produk B', price:15000, hpp:7000, stock:40, type:'finished' },
                        { id:3, name:'Bahan Baku', price:0, hpp:5000, stock:100, type:'raw' }
                    ];
                    this.data.employees = [ { pin:'1234', name:'Admin', role:'admin' }, { pin:'0000', name:'Staff', role:'cashier' } ];
                    this.save();
                }
            },
            save() { localStorage.setItem('umkm_erp_v37', JSON.stringify(this.data)); },
            addTransaction(items, total, pay, change, method) {
                const trx = { id:'TRX'+Date.now().toString().slice(-6), date:new Date().toISOString(), items, total, pay, change, method };
                this.data.transactions.unshift(trx);
                items.forEach(i => { const p=this.data.products.find(x=>x.id===i.id); if(p) p.stock-=i.qty; });
                this.save(); return trx;
            },
            addWAOrder(customer, phone, items, total) {
                const ord = { id:'WA'+Date.now().toString().slice(-6), date:new Date().toISOString(), customer, phone, items, total, status:'completed' };
                this.data.waOrders.unshift(ord);
                items.forEach(i => { const p=this.data.products.find(x=>x.id===i.id); if(p) p.stock-=i.qty; });
                this.save(); return ord;
            },
            addPurchase(mode, data) {
                const pur = { id:'PO'+Date.now().toString().slice(-6), date:new Date().toISOString(), ...data, type: mode };
                this.data.purchases.unshift(pur);
                if (mode === 'new') this.data.products.push({ id: Date.now(), name: data.name, price: 0, hpp: data.hpp, stock: data.qty, type: 'raw' });
                else if (mode === 'stock') { const p = this.data.products.find(x=>x.id == data.productId); if(p) p.stock += data.qty; }
                this.save();
            },
            getStats(filterDate = null) {
                let trs = this.data.transactions, was = this.data.waOrders, purs = this.data.purchases;
                if (filterDate) {
                    trs = trs.filter(t => t.date.startsWith(filterDate));
                    was = was.filter(w => w.date.startsWith(filterDate));
                    purs = purs.filter(p => p.date.startsWith(filterDate));
                }
                const revOff = trs.reduce((s,t)=>s+t.total,0), revOn = was.reduce((s,w)=>s+w.total,0);
                const totalRev = revOff + revOn;
                const totalHpp = trs.reduce((s,t)=>s+t.items.reduce((a,i)=>a+(i.hpp*i.qty),0),0) + was.reduce((s,w)=>s+w.items.reduce((a,i)=>a+(i.hpp*i.qty),0),0);
                const exp = purs.reduce((s,p)=>s+p.total, 0);
                return { revenue: totalRev, revOff, revOn, hpp: totalHpp, gross: totalRev-totalHpp, net: (totalRev-totalHpp)-exp, exp };
            }
        };

        const Login = {
            pin: '',
            input(n) { if(this.pin.length<4) { this.pin+=n; this.update(); } },
            clear() { this.pin=''; this.update(); },
            update() { document.getElementById('pin-display').textContent='‚Ä¢'.repeat(this.pin.length); },
            submit() {
                const u = DB.data.employees.find(e=>e.pin===this.pin);
                if(u) { 
                    this.user=u; document.getElementById('login-screen').style.display='none'; document.getElementById('app-main').style.display='flex'; 
                    if(u.role === 'admin') document.querySelectorAll('.nav-item.hidden').forEach(el=>el.classList.remove('hidden'));
                    Router.go(u.role==='admin'?'dashboard':'pos');
                } else { UI.toast('PIN Salah!'); this.clear(); }
            }
        };

        const Router = {
            go(view) {
                const isOwnerOnly = ['dashboard','finance','employees','sales','expenses','inventory'].includes(view);
                if(Login.user?.role === 'cashier' && isOwnerOnly) return UI.toast('Akses Ditolak!');
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                const navItem = document.getElementById('nav-'+view); if(navItem) navItem.classList.add('active');
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('page-title').textContent = view.toUpperCase();
                const content = document.getElementById('content');
                if(Views[view]) content.innerHTML = Views[view]();
                if(view === 'pos') Cart.render(); if(view === 'online') WACart.render();
            }
        };

        const UI = {
            fmt(n) { return 'Rp ' + (n||0).toLocaleString('id-ID'); },
            fmtDT(iso) { const d = new Date(iso); return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short' }) + ' ' + d.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' }); },
            toast(msg) { const t=document.getElementById('toast-msg'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); },
            modal(title, html, btn) {
                const m=document.createElement('div'); m.className = 'modal-overlay';
                m.innerHTML = `<div class="card" style="width:100%; max-width:420px;"><h2 class="mb-4">${title}</h2>${html}<div class="flex gap-4 mt-6 justify-end">${btn}</div></div>`;
                document.body.appendChild(m);
                m.onclick = e => { if(e.target===m) m.remove(); };
            },
            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.remove('hidden');
                event.currentTarget.classList.add('active');
            }
        };

        const Cart = {
            items: [],
            add(p) { const ex=this.items.find(i=>i.id===p.id); if(ex) ex.qty++; else this.items.push({...p, qty:1}); this.render(); UI.toast('Ditambah'); },
            remove(id) { this.items = this.items.filter(i=>i.id!==id); this.render(); },
            total() { return this.items.reduce((s,i)=>s+(i.price*i.qty), 0); },
            render() {
                const html = this.items.length === 0 ? '<div class="text-center opacity-50 p-4">Kosong</div>' : this.items.map(i => `<div class="flex justify-between items-center mb-2"><div><b>${i.name}</b><br><small>${i.qty} x ${UI.fmt(i.price)}</small></div><button class="btn btn-ghost" style="color:red; padding:5px 10px;" onclick="Cart.remove(${i.id})">‚úï</button></div>`).join('');
                if(document.getElementById('cart-list')) document.getElementById('cart-list').innerHTML = html;
                if(document.getElementById('cart-total')) document.getElementById('cart-total').textContent = UI.fmt(this.total());
            },
            clear() { this.items = []; this.render(); }
        };

        const WACart = {
            items: [],
            add(p) { const ex=this.items.find(i=>i.id===p.id); if(ex) ex.qty++; else this.items.push({...p, qty:1}); this.render(); UI.toast('WA Masuk'); },
            remove(id) { this.items = this.items.filter(i=>i.id!==id); this.render(); },
            total() { return this.items.reduce((s,i)=>s+(i.price*i.qty), 0); },
            render() {
                const html = this.items.length === 0 ? '<div class="text-center opacity-50 p-4">Order WA...</div>' : this.items.map(i => `<div class="flex justify-between items-center mb-2"><div><b>${i.name}</b><br><small>${i.qty} x ${UI.fmt(i.price)}</small></div><button class="btn btn-ghost" style="color:red; padding:5px 10px;" onclick="WACart.remove(${i.id})">‚úï</button></div>`).join('');
                if(document.getElementById('wa-cart-list')) document.getElementById('wa-cart-list').innerHTML = html;
                if(document.getElementById('wa-cart-total')) document.getElementById('wa-cart-total').textContent = UI.fmt(this.total());
            },
            clear() { this.items = []; this.render(); }
        };

        const Views = {
            dashboard() {
                const s = DB.getStats(new Date().toISOString().slice(0, 10));
                return `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                        <div class="card">OFFLINE<br><h2>${UI.fmt(s.revOff)}</h2></div>
                        <div class="card">ONLINE WA<br><h2 style="color:var(--success)">${UI.fmt(s.revOn)}</h2></div>
                        <div class="card" style="background:var(--accent-grad); color:white;">TOTAL REVENUE<br><h2>${UI.fmt(s.revenue)}</h2></div>
                    </div>
                    <div class="card mt-4"><h3>Profit Laporan</h3><div class="flex justify-between py-2 border-bottom"><span>Gross Profit</span><b>${UI.fmt(s.gross)}</b></div><div class="flex justify-between py-2 border-bottom"><span>Pengeluaran</span><b style="color:red">(${UI.fmt(s.exp)})</b></div><div class="flex justify-between py-2"><span>Net Profit</span><b style="color:green; font-size:1.4rem;">${UI.fmt(s.net)}</b></div></div>
                `;
            },
            pos() {
                const pds = DB.data.products.filter(p=>p.type==='finished');
                return `<div class="pos-layout"><div class="pos-main"><input type="text" class="form-control mb-4" placeholder="Cari menu..."><div class="pos-grid">${pds.map(p=>`<div class="product" onclick='Cart.add(${JSON.stringify(p)})'><img src="https://picsum.photos/seed/${p.id}/300/200" class="p-img"><div class="p-body"><b>${p.name}</b><br><span style="color:var(--accent)">${UI.fmt(p.price)}</span></div></div>`).join('')}</div></div><div class="cart-panel"><h3>Bill Summary</h3><div id="cart-list" style="flex:1; overflow-y:auto;"></div><hr><div class="flex justify-between mb-4"><span>Total</span><b id="cart-total" style="font-size:1.5rem; color:var(--accent);">Rp 0</b></div><button class="btn btn-primary w-full" onclick="Views.checkout()">PROSES BAYAR</button></div></div>`;
            },
            online() {
                const pds = DB.data.products.filter(p=>p.type==='finished');
                return `<div class="pos-layout"><div class="pos-main"><input type="text" class="form-control mb-4" placeholder="Cari Order WA..."><div class="pos-grid">${pds.map(p=>`<div class="product" onclick='WACart.add(${JSON.stringify(p)})'><img src="https://picsum.photos/seed/${p.id}/300/200" class="p-img"><div class="p-body"><b>${p.name}</b><br><span style="color:var(--success)">${UI.fmt(p.price)}</span></div></div>`).join('')}</div></div><div class="cart-panel"><h3>üì± WA Order</h3><div id="wa-cart-list" style="flex:1; overflow-y:auto;"></div><hr><div class="flex justify-between mb-4"><span>Total</span><b id="wa-cart-total" style="color:var(--success);">Rp 0</b></div><button class="btn btn-success w-full" onclick="Views.checkoutWA()">SIMPAN ORDER</button></div></div>`;
            },
            checkout() {
                const tot = Cart.total(); if(tot === 0) return UI.toast('Pilih produk!');
                const html = `
                    <div class="text-center mb-4"><h1>${UI.fmt(tot)}</h1></div>
                    <label class="font-bold">Metode Pembayaran</label>
                    <select id="p-method" class="form-control mb-4" onchange="Views.togglePayMode(${tot})">
                        <option value="cash">Tunai (Cash)</option>
                        <option value="transfer">Transfer / QRIS</option>
                    </select>
                    <div id="cash-input-box">
                        <label class="font-bold">Bayar Tunai</label>
                        <input type="number" id="p-amt" class="form-control" onkeyup="Views.calcChange(${tot})">
                        <div id="p-change" class="mt-2 font-bold text-danger"></div>
                    </div>`;
                UI.modal('KONFIRMASI PEMBAYARAN', html, `<button class="btn btn-ghost" onclick="document.querySelector('.modal-overlay').remove()">Batal</button><button class="btn btn-primary" onclick="Views.finishPay(${tot})">KONFIRMASI</button>`);
            },
            togglePayMode(tot) {
                const m = document.getElementById('p-method').value;
                const box = document.getElementById('cash-input-box');
                const inp = document.getElementById('p-amt');
                if(m === 'transfer') {
                    box.classList.add('hidden');
                    inp.value = tot;
                } else {
                    box.classList.remove('hidden');
                    inp.value = '';
                }
            },
            calcChange(tot) { const b = parseFloat(document.getElementById('p-amt').value) || 0; document.getElementById('p-change').textContent = b >= tot ? 'Kembali: ' + UI.fmt(b-tot) : 'Uang Kurang!'; },
            finishPay(tot) {
                const m = document.getElementById('p-method').value;
                const b = parseFloat(document.getElementById('p-amt').value) || (m==='transfer' ? tot : 0);
                if(b < tot) return UI.toast('Pembayaran Kurang!');
                const trx = DB.addTransaction(Cart.items, tot, b, b-tot, m);
                document.querySelector('.modal-overlay').remove(); Cart.clear();
                UI.modal('Berhasil!', `<p>Transaksi ${trx.id} sukses!</p>`, `<button class="btn btn-ghost" onclick="document.querySelector('.modal-overlay').remove(); Router.go('pos');">Tutup</button><button class="btn btn-primary" onclick="Views.printTrx('${trx.id}')">üñ®Ô∏è Cetak Struk</button>`);
            },
            checkoutWA() {
                const tot = WACart.total(); if(tot === 0) return UI.toast('Pilih produk!');
                const html = `<input type="text" id="wa-name" class="form-control mb-2" placeholder="Nama Customer"><input type="number" id="wa-phone" class="form-control" placeholder="No WA (628...)">`;
                UI.modal('SIMPAN ORDER WA', html, `<button class="btn btn-ghost" onclick="document.querySelector('.modal-overlay').remove()">Batal</button><button class="btn btn-success" onclick="Views.finishWA()">SIMPAN</button>`);
            },
            finishWA() {
                const n = document.getElementById('wa-name').value, p = document.getElementById('wa-phone').value;
                if(!n || !p) return UI.toast('Lengkapi data!');
                const ord = DB.addWAOrder(n, p, WACart.items, WACart.total());
                document.querySelector('.modal-overlay').remove(); WACart.clear();
                UI.modal('Berhasil!', `<p>Order ${ord.id} disimpan.</p>`, `<button class="btn btn-ghost" onclick="document.querySelector('.modal-overlay').remove(); Router.go('online');">Tutup</button><button class="btn btn-primary" onclick="Views.printWA('${ord.id}')">üñ®Ô∏è Cetak</button>`);
            },
            supply() {
                const raw = DB.data.products.filter(p=>p.type==='raw');
                return `
                <div class="flex gap-2 mb-4">
                    <button class="tab-btn active" onclick="UI.switchTab('stok')">Pembelian Stok</button>
                    <button class="tab-btn" onclick="UI.switchTab('ops')">Operasional</button>
                </div>
                <div id="tab-stok" class="tab-content">
                    <div class="card">
                        <h3>Input Stok</h3>
                        <div class="flex gap-2 mb-4">
                            <button id="btn-old" class="btn btn-primary" onclick="Views.toggleStokMode('old')">Barang Lama</button>
                            <button id="btn-new" class="btn btn-ghost" onclick="Views.toggleStokMode('new')">+ Barang Baru</button>
                        </div>
                        <div id="box-old">
                            <label class="font-bold">Pilih Barang</label>
                            <select id="s-id" class="form-control mb-4">${raw.map(p=>`<option value="${p.id}">${p.name} (Stok: ${p.stock})</option>`).join('')}</select>
                        </div>
                        <div id="box-new" class="hidden">
                            <input type="text" id="n-name" class="form-control mb-2" placeholder="Nama Barang"><input type="number" id="n-hpp" class="form-control mb-4" placeholder="HPP Unit">
                        </div>
                        <div class="flex gap-2">
                            <input type="number" id="s-qty" class="form-control" placeholder="Qty"><input type="number" id="s-total" class="form-control" placeholder="Total Harga">
                        </div>
                        <button class="btn btn-primary w-full mt-6" onclick="Views.saveSupply()">SIMPAN KE GUDANG</button>
                    </div>
                </div>
                <div id="tab-ops" class="tab-content hidden">
                    <div class="card"><h3>Biaya Operasional</h3><input type="text" id="ops-name" class="form-control mb-2" placeholder="Gaji/Listrik"><input type="number" id="ops-cost" class="form-control mb-4"><button class="btn btn-danger w-full" onclick="Views.saveOps()">CATAT PENGELUARAN</button></div>
                </div>`;
            },
            toggleStokMode(m) {
                document.getElementById('box-old').classList.toggle('hidden', m==='new');
                document.getElementById('box-new').classList.toggle('hidden', m==='old');
                document.getElementById('btn-old').className = m==='old' ? 'btn btn-primary' : 'btn btn-ghost';
                document.getElementById('btn-new').className = m==='new' ? 'btn btn-primary' : 'btn btn-ghost';
            },
            saveSupply() {
                const isNew = !document.getElementById('box-new').classList.contains('hidden');
                const q = parseInt(document.getElementById('s-qty').value), t = parseFloat(document.getElementById('s-total').value);
                if(!q || !t) return UI.toast('Isi Qty & Total!');
                if(isNew) {
                    const n = document.getElementById('n-name').value, h = parseFloat(document.getElementById('n-hpp').value);
                    DB.addPurchase('new', { name:n, hpp:h, qty:q, total:t });
                } else {
                    const id = document.getElementById('s-id').value;
                    DB.addPurchase('stock', { productId:id, qty:q, total:t });
                }
                UI.toast('Stok Diperbarui!'); Router.go('supply');
            },
            saveOps() {
                const n = document.getElementById('ops-name').value, c = parseFloat(document.getElementById('ops-cost').value);
                if(!n || !c) return UI.toast('Lengkapi data!');
                DB.addPurchase('misc', { name:n, total:c }); UI.toast('Beban Dicatat!'); Router.go('supply');
            },
            inventory() {
                const rows = DB.data.products.map(p=>`<tr><td><b>${p.name}</b></td><td>${p.stock}</td><td>${UI.fmt(p.hpp)}</td><td>${UI.fmt(p.stock*p.hpp)}</td></tr>`).join('');
                return `<div class="card"><h3>Inventori & Nilai Aset</h3><div class="table-responsive"><table><thead><tr><th>Produk</th><th>Stok</th><th>HPP</th><th>Total Nilai</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
            },
            finance() {
                const s = DB.getStats();
                return `<div class="card"><h3>Laporan Keuangan</h3><table style="width:100%"><tr><td>Revenue</td><td align="right">${UI.fmt(s.revenue)}</td></tr><tr><td>HPP Terjual</td><td align="right">(${UI.fmt(s.hpp)})</td></tr><tr style="background:#f1f5f9"><td><b>Gross Profit</b></td><td align="right">${UI.fmt(s.gross)}</td></tr><tr><td>Expenses</td><td align="right">(${UI.fmt(s.exp)})</td></tr><tr style="background:#dcfce7"><td><b>NET PROFIT</b></td><td align="right"><b style="color:green">${UI.fmt(s.net)}</b></td></tr></table></div>`;
            },
            sales() {
                const all = [...DB.data.transactions.map(t=>({...t, src:'OFFLINE'})), ...DB.data.waOrders.map(w=>({...w, src:'ONLINE'}))].sort((a,b)=>new Date(b.date)-new Date(a.date));
                const rows = all.map(s => `<tr><td>${UI.fmtDT(s.date)}</td><td><span style="padding:4px 8px; border-radius:4px; font-size:10px; background:${s.src==='OFFLINE'?'#e2e8f0':'#dcfce7'}">${s.src}</span></td><td>${s.customer||'Toko'}</td><td align="right">${UI.fmt(s.total)}</td></tr>`).join('');
                return `<div class="card"><h3>Log Penjualan</h3><div class="table-responsive"><table><thead><tr><th>Waktu</th><th>Tipe</th><th>Customer</th><th align="right">Total</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
            },
            expenses() {
                const rows = DB.data.purchases.map(e => `<tr><td>${UI.fmtDT(e.date)}</td><td>${e.type}</td><td>${e.name||'Stok'}</td><td align="right" style="color:red">${UI.fmt(e.total)}</td></tr>`).join('');
                return `<div class="card"><h3>Log Pengeluaran</h3><div class="table-responsive"><table><thead><tr><th>Waktu</th><th>Kategori</th><th>Detail</th><th align="right">Jumlah</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
            },
            employees() {
                const rows = DB.data.employees.map(e => `<tr><td>${e.name}</td><td>${e.role}</td></tr>`).join('');
                return `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
                    <div class="card"><h3>Tambah Member</h3><input type="text" id="e-name" class="form-control mb-2" placeholder="Nama"><select id="e-role" class="form-control mb-2"><option value="cashier">Kasir</option><option value="admin">Admin</option></select><input type="password" id="e-pin" class="form-control mb-4" placeholder="PIN 4 Digit"><button class="btn btn-primary w-full" onclick="Views.addMember()">DAFTARKAN</button></div>
                    <div class="card"><h3>Ganti PIN Saya</h3><input type="password" id="old-p" class="form-control mb-2" placeholder="PIN Lama"><input type="password" id="new-p" class="form-control mb-4" placeholder="PIN Baru"><button class="btn btn-danger w-full" onclick="Views.changePin()">UPDATE PIN</button></div>
                </div>
                <div class="card mt-4"><h3>Tim</h3><table><thead><tr><th>Nama</th><th>Jabatan</th></tr></thead><tbody>${rows}</tbody></table><button class="btn btn-danger w-full mt-4" onclick="if(confirm('RESET SEMUA DATA?')){localStorage.removeItem('umkm_erp_v37');location.reload();}">RESET PABRIK (Hapus Semua Data)</button></div>`;
            },
            addMember() {
                const n = document.getElementById('e-name').value, p = document.getElementById('e-pin').value;
                if(!n || !p) return UI.toast('Lengkapi data!');
                DB.data.employees.push({ name:n, role:document.getElementById('e-role').value, pin:p }); DB.save(); UI.toast('Member Ditambah!'); Router.go('employees');
            },
            changePin() {
                const o = document.getElementById('old-p').value, n = document.getElementById('new-p').value;
                if(o !== Login.user.pin) return UI.toast('PIN Lama Salah!');
                const u = DB.data.employees.find(e=>e.pin === Login.user.pin);
                if(u) { u.pin = n; Login.user.pin = n; DB.save(); UI.toast('PIN Diupdate!'); Router.go('employees'); }
            },
            printTrx(id) { const t=DB.data.transactions.find(x=>x.id===id); if(t) this.print(t); },
            printWA(id) { const w=DB.data.waOrders.find(x=>x.id===id); if(w) this.print({...w, method:'wa'}); },
            print(d) {
                document.getElementById('r-shop-name').textContent = APP_SETTINGS.shopName;
                document.getElementById('r-shop-addr').textContent = APP_SETTINGS.shopAddress;
                document.getElementById('r-items').innerHTML = d.items.map(i=>`<div class="flex justify-between"><span>${i.name} x${i.qty}</span><span>${UI.fmt(i.price*i.qty)}</span></div>`).join('');
                document.getElementById('r-total').textContent = UI.fmt(d.total);
                window.print();
            }
        };

        window.onload = () => {
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long' });
            DB.init();
            setTimeout(() => { document.getElementById('loading-screen').style.display='none'; document.getElementById('login-screen').style.display='flex'; }, 800);
        };
    </script>
</body>
</html>
