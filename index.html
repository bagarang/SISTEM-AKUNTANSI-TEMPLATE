<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UMKM ERP Ultimate - Sembako v56</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-grad: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --accent-grad: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --success-grad: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-grad: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --primary: #0f172a; --accent: #2563eb; --success: #10b981; --danger: #ef4444;
            --bg: #f1f5f9; --surface: #ffffff; --text: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --radius-lg: 20px; --radius-md: 12px;
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .font-bold { font-weight: 700; } .text-center { text-align: center; }
        .p-4 { padding: 1.25rem; } .mb-4 { margin-bottom: 1rem; } .w-full { width: 100%; } .gap-2 { gap: 8px; }

        .btn { padding: 12px 20px; border-radius: var(--radius-md); border: none; font-weight: 700; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 10px; font-size: 0.9rem; justify-content: center; color: white; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent-grad); box-shadow: 0 4px 14px rgba(37,99,235,0.3); }
        .btn-success { background: var(--success-grad); box-shadow: 0 4px 14px rgba(16,185,129,0.3); }
        .btn-danger { background: var(--danger-grad); box-shadow: 0 4px 14px rgba(239,68,68,0.3); }
        .btn-ghost { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        
        .card { background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .form-control { width:100%; padding:12px; border:2px solid var(--border); border-radius: var(--radius-md); font-size: 0.95rem; background: var(--surface); transition: 0.3s; }

        .tab-btn { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 700; color: var(--text-muted); font-size: 0.8rem; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .table-responsive { width: 100%; overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border); }
        table { width:100%; border-collapse:collapse; white-space: nowrap; }
        th { text-align:left; padding:12px; background: #f8fafc; color:var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        td { padding:12px; border-bottom:1px solid var(--border); font-size: 0.85rem; }

        #app-main { display:none; height:100vh; width: 100%; overflow: hidden; }
        aside { width: 260px; background: var(--primary-grad); display:flex; flex-direction:column; z-index:1000; transition: 0.4s; }
        .nav-item { padding:12px 20px; border-radius: var(--radius-md); margin: 4px 12px; cursor:pointer; display:flex; align-items:center; gap:14px; color: rgba(255,255,255,0.7); font-weight: 500; font-size: 0.9rem; }
        .nav-item.active { background: var(--accent-grad); color: white; }
        
        main { flex:1; display:flex; flex-direction:column; overflow:hidden; background: var(--bg); position: relative; }
        header { height:70px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 20px; justify-content:space-between; flex-shrink: 0; }
        .content { flex:1; overflow-y:auto; padding:20px; }

        .pos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(145px, 1fr)); gap: 12px; overflow-y: auto; padding-bottom: 20px; }
        .product { border: 1px solid var(--border); border-radius: var(--radius-lg); overflow:hidden; cursor:pointer; background:white; transition: 0.2s; }
        .p-img { height:80px; background:#f1f5f9; border-bottom:1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 2rem; }

        .cart-panel { width: 320px; background: white; border-radius: var(--radius-lg); border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; padding: 20px; box-shadow: var(--shadow-md); }

        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:5000; backdrop-filter:blur(8px); padding:20px; }
        .toast { position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background: var(--primary); color:white; padding:15px 30px; border-radius:50px; z-index:99999; font-weight: 600; opacity:0; transition: 0.4s; pointer-events:none; }
        .toast.show { opacity:1; }

        #loading-screen { position: fixed; inset:0; background: var(--primary-grad); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }

        @media print {
            body * { visibility: hidden !important; }
            #thermal-receipt, #thermal-receipt * { visibility: visible !important; }
            #thermal-receipt { position: absolute; left: 0; top: 0; width: 58mm; display: block !important; padding: 5mm; background: white; color: black; font-family: 'Roboto Mono', monospace; font-size: 10px; }
        }
        @media (max-width: 1024px) {
            .cart-panel { display: none; }
            aside { position: fixed; transform: translateX(-100%); height: 100%; width: 260px; }
            aside.open { transform: translateX(0); }
            .pos-layout { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div id="loading-screen"><div class="spinner"></div><h2 style="margin-top:20px;">UMKM ERP ULTIMATE</h2></div>

    <div id="login-screen" style="position: fixed; inset:0; background:var(--bg); z-index:9998; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center; padding: 40px;">
            <div style="margin-bottom: 20px;"><img src="https://cdn-icons-png.flaticon.com/512/6195/6195699.png" style="width:60px;"></div>
            <h2 class="mb-4">Login Sistem</h2>
            <div style="background:#f1f5f9; padding:20px; border-radius:20px; font-family:'Roboto Mono'; font-size:2.5rem; color:var(--accent); margin-bottom:25px; border:2px solid var(--border); height:85px; display:flex; align-items:center; justify-content:center;" id="pin-display"></div>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <button class="btn btn-ghost" onclick="Login.input(1)">1</button><button class="btn btn-ghost" onclick="Login.input(2)">2</button><button class="btn btn-ghost" onclick="Login.input(3)">3</button>
                <button class="btn btn-ghost" onclick="Login.input(4)">4</button><button class="btn btn-ghost" onclick="Login.input(5)">5</button><button class="btn btn-ghost" onclick="Login.input(6)">6</button>
                <button class="btn btn-ghost" onclick="Login.input(7)">7</button><button class="btn btn-ghost" onclick="Login.input(8)">8</button><button class="btn btn-ghost" onclick="Login.input(9)">9</button>
                <button class="btn btn-danger" onclick="Login.clear()">C</button><button class="btn btn-ghost" onclick="Login.input(0)">0</button>
                <button class="btn btn-primary" onclick="Login.submit()">OK</button>
            </div>
        </div>
    </div>

    <div id="app-main" class="flex">
        <aside id="sidebar">
            <div style="padding:25px; text-align:center;"><h2 style="color:white; font-weight:800; margin:0;">UMKM ERP.</h2></div>
            <nav style="flex:1; overflow-y:auto;">
                <a class="nav-item hidden" id="nav-dashboard" onclick="Router.go('dashboard')"><span>üìä</span> <span>Dashboard</span></a>
                <a class="nav-item hidden" id="nav-master" onclick="Router.go('master')"><span>‚öôÔ∏è</span> <span>Produk</span></a>
                <a class="nav-item" id="nav-pos" onclick="Router.go('pos')"><span>üõí</span> <span>Kasir Toko</span></a>
                <a class="nav-item" id="nav-online" onclick="Router.go('online')"><span>üì±</span> <span>Order WA</span></a>
                <a class="nav-item hidden" id="nav-sales" onclick="Router.go('sales')"><span>üìà</span> <span>Log Penjualan</span></a>
                <a class="nav-item hidden" id="nav-expenses" onclick="Router.go('expenses')"><span>üìâ</span> <span>Log Pengeluaran</span></a>
                <a class="nav-item" id="nav-supply" onclick="Router.go('supply')"><span>üöö</span> <span>Operasional</span></a>
                <a class="nav-item hidden" id="nav-inventory" onclick="Router.go('inventory')"><span>üì¶</span> <span>Stok Barang</span></a>
                <a class="nav-item hidden" id="nav-finance" onclick="Router.go('finance')"><span>üìÑ</span> <span>Laporan Keuangan</span></a>
                <a class="nav-item hidden" id="nav-employees" onclick="Router.go('employees')"><span>üë•</span> <span>Tim</span></a>
            </nav>
            <div style="padding:20px;"><button class="btn btn-danger w-full" onclick="location.reload()">Log Out</button></div>
        </aside>

        <main>
            <header>
                <button class="btn btn-ghost" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
                <div id="page-title" class="font-bold">DASHBOARD</div>
                <div id="date-display" class="hidden md:block"></div>
            </header>
            <div id="content" class="content"></div>
        </main>
    </div>

    <div id="thermal-receipt" style="display:none;">
        <div style="text-align:center; margin-bottom:10px;"><b id="r-shop-name">SEMBAKO ELITE</b><br><span id="r-shop-addr" style="font-size:9px;">Pasar Digital Blok B-09</span></div>
        <div style="border-top:1px dashed black; margin:5px 0;"></div>
        <div id="r-items"></div>
        <div style="border-top:1px dashed black; margin:5px 0;"></div>
        <div class="flex justify-between" style="font-weight:bold;"><span>TOTAL</span><span id="r-total"></span></div>
        <div style="text-align:center; margin-top:15px; font-size:9px;">TERIMA KASIH</div>
    </div>

    <div id="toast-msg" class="toast"></div>

    <script>
        const APP_SETTINGS = { shopName: "SEMBAKO ELITE", shopAddress: "Pasar Digital Blok B-09" };
        const STORAGE_KEY = 'umkm_erp_sembako_v56_final';

        const DB = {
            data: { products: [], transactions: [], purchases: [], employees: [], waOrders: [] },
            init() {
                const store = localStorage.getItem(STORAGE_KEY);
                if(store) this.data = JSON.parse(store);
                else {
                    // SEED DATA LENGKAP - STOK AWAL BENAR
                    this.data.products = [¬†
                        // PHYSICAL ASSETS (Hanya ini yang muncul di Stok Barang)
                        { id:101, name:'Beras Mentah', price:0, hpp:10000, stock:100, type:'raw' },
                        { id:102, name:'Rokok Surya 16 Master', price:0, hpp:35000, stock:1000, type:'raw' },
                        { id:103, name:'Rokok Surya 12 Master', price:0, hpp:25000, stock:1000, type:'raw' },
                        { id:104, name:'GG Filter Master', price:0, hpp:25000, stock:1000, type:'raw' },
                        { id:105, name:'Sampoerna 12 Master', price:0, hpp:25000, stock:1000, type:'raw' },
                        { id:106, name:'Sampoerna 16 Master', price:0, hpp:45000, stock:1000, type:'raw' },
                        { id:307, name:'TELOR', price:0, hpp:16000, stock:100, type:'raw' }, // Induk Stok
                        { id:108, name:'Permen Master', price:0, hpp:50, stock:10000, type:'raw' },
                        { id:109, name:'Wafer Master', price:0, hpp:500, stock:10000, type:'raw' },
                        { id:110, name:'Bensin Master', price:0, hpp:10000, stock:100, type:'raw' },
                        { id:201, name:'Plastik Kresek', price:0, hpp:200, stock:500, type:'non-prod' },
                        
                        // POS VOUCHERS (Hanya untuk Jualan)
                        { id:1, name:'Beras (Kg)', price:12000, hpp:10000, stock:0, type:'finished', icon:'üåæ', recipe: [{name:'Beras Mentah', qty:1}] },
                        { id:2, name:'Rokok Surya 16', price:37000, hpp:35000, stock:0, type:'finished', icon:'üö¨', recipe: [{name:'Rokok Surya 16 Master', qty:1}] },
                        { id:3, name:'Rokok Surya 12', price:27000, hpp:25000, stock:0, type:'finished', icon:'üö¨', recipe: [{name:'Rokok Surya 12 Master', qty:1}] },
                        { id:4, name:'GG Filter', price:27000, hpp:25000, stock:0, type:'finished', icon:'üö¨', recipe: [{name:'GG Filter Master', qty:1}] },
                        { id:5, name:'Sampoerna 12', price:30000, hpp:25000, stock:0, type:'finished', icon:'üö¨', recipe: [{name:'Sampoerna 12 Master', qty:1}] },
                        { id:6, name:'Sampoerna 16', price:50000, hpp:45000, stock:0, type:'finished', icon:'üö¨', recipe: [{name:'Sampoerna 16 Master', qty:1}] },
                        { id:7, name:'Telor (1 Kg)', price:22000, hpp:16000, stock:0, type:'finished', icon:'ü•ö', recipe: [{name:'TELOR', qty:1}] },
                        { id:8, name:'Telor (1/2 Kg)', price:16000, hpp:8000, stock:0, type:'finished', icon:'ü•ö', recipe: [{name:'TELOR', qty:0.5}] },
                        { id:9, name:'Telor (1/4 Kg)', price:9000, hpp:4000, stock:0, type:'finished', icon:'ü•ö', recipe: [{name:'TELOR', qty:0.25}] },
                        { id:10, name:'Permen', price:250, hpp:50, stock:0, type:'finished', icon:'üç¨', recipe: [{name:'Permen Master', qty:1}] },
                        { id:11, name:'Wafer', price:1500, hpp:500, stock:0, type:'finished', icon:'üç™', recipe: [{name:'Wafer Master', qty:1}] },
                        { id:12, name:'Bensin', price:12000, hpp:10000, stock:0, type:'finished', icon:'‚õΩ', recipe: [{name:'Bensin Master', qty:1}] }
                    ];
                    this.data.employees = [ { pin:'1234', name:'Owner', role:'admin' }, { pin:'0000', name:'Staff', role:'cashier' } ];
                    this.save();
                }
            },
            save() { localStorage.setItem(STORAGE_KEY, JSON.stringify(this.data)); },
            addTransaction(items, total, pay, change, method, npUsed = []) {
                const trx = { id:'TRX'+Date.now().toString().slice(-6), date:new Date().toISOString(), items, total, pay, change, method, npUsed };
                this.data.transactions.unshift(trx);
                this.processStockAndExpense(items, npUsed);
                this.save(); return trx;
            },
            addWAOrder(customer, phone, items, total, npUsed = []) {
                const ord = { id:'WA'+Date.now().toString().slice(-6), date:new Date().toISOString(), customer, phone, items, total, npUsed, status:'completed' };
                this.data.waOrders.unshift(ord);
                this.processStockAndExpense(items, npUsed);
                this.save(); return ord;
            },
            processStockAndExpense(items, npUsed) {
                // SHARING STOCK LOGIC
                items.forEach(sold => {
                    const p = this.data.products.find(x => x.id === sold.id);
                    if (p && p.recipe) {
                        p.recipe.forEach(ing => {
                            const raw = this.data.products.find(r => r.name.toLowerCase() === ing.name.toLowerCase());
                            if (raw) raw.stock -= (ing.qty * sold.qty);
                        });
                    } else if(p) { p.stock -= sold.qty; }
                });
                // NON-PROD EXPENSE
                npUsed.forEach(id => {
                    const np = this.data.products.find(x => x.id == id);
                    if (np) {
                        np.stock -= 1;
                        this.data.purchases.unshift({ date: new Date().toISOString(), type: 'non-prod-usage', name: np.name, total: np.hpp, isUsage: true });
                    }
                });
            },
            getStats(filterDate = null) {
                let trs = this.data.transactions, was = this.data.waOrders, purs = this.data.purchases;
                if (filterDate) {
                    trs = trs.filter(t => t.date.startsWith(filterDate));
                    was = was.filter(w => w.date.startsWith(filterDate));
                    purs = purs.filter(p => p.date.startsWith(filterDate));
                }
                const rev = trs.reduce((s,t)=>s+t.total,0) + was.reduce((s,w)=>s+w.total,0);
                const hppSold = trs.reduce((s,t)=>s+t.items.reduce((a,i)=>a+(i.hpp*i.qty),0),0) + was.reduce((s,w)=>s+w.items.reduce((a,i)=>a+(i.hpp*i.qty),0),0);
                const expOther = purs.filter(p=>p.type==='misc' || p.type==='non-prod-usage').reduce((s,p)=>s+p.total, 0);
                return { revenue: rev, hpp: hppSold, gross: rev-hppSold, exp: expOther, netProfit: (rev-hppSold)-expOther };
            }
        };

        const Login = {
            pin: '',
            input(n) { if(this.pin.length<4) { this.pin+=n; this.update(); } },
            clear() { this.pin=''; this.update(); },
            update() { document.getElementById('pin-display').textContent='‚Ä¢'.repeat(this.pin.length); },
            submit() {
                const u = DB.data.employees.find(e=>e.pin===this.pin);
                if(u) {¬†
                    this.user=u; document.getElementById('login-screen').style.display='none'; document.getElementById('app-main').style.display='flex';¬†
                    if(u.role === 'admin') document.querySelectorAll('.nav-item.hidden').forEach(el=>el.classList.remove('hidden'));
                    Router.go(u.role==='admin'?'dashboard':'pos');
                } else { UI.toast('PIN Salah!'); this.clear(); }
            }
        };

        const Router = {
            go(view) {
                const isOwnerOnly = ['dashboard','finance','employees','sales','expenses','inventory','master'].includes(view);
                if(Login.user?.role === 'cashier' && isOwnerOnly) return UI.toast('Akses Ditolak!');
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                const navItem = document.getElementById('nav-'+view); if(navItem) navItem.classList.add('active');
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('page-title').textContent = view.toUpperCase();
                const content = document.getElementById('content');
                if(Views[view]) content.innerHTML = Views[view]();
                if(view === 'pos') Cart.render(); if(view === 'online') WACart.render();
            }
        };

        const UI = {
            fmt(n) { return 'Rp ' + (n||0).toLocaleString('id-ID'); },
            fmtDT(iso) { const d = new Date(iso); return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short' }) + ' ' + d.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' }); },
            toast(msg) { const t=document.getElementById('toast-msg'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); },
            modal(title, html, btn) {
                const m=document.createElement('div'); m.className = 'modal-overlay';
                m.innerHTML = `<div class="card" style="width:100%; max-width:420px;"><h2 class="mb-4">${title}</h2>${html}<div class="flex gap-4 mt-6 justify-end">${btn}</div></div>`;
                document.body.appendChild(m);
                m.onclick = e => { if(e.target===m) m.remove(); };
            },
            switchTab(tab) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById('tab-' + tab).classList.remove('hidden');
                event.currentTarget.classList.add('active');
            }
        };

        const Cart = {
            items: [],
            add(p) { const ex=this.items.find(i=>i.id===p.id); if(ex) ex.qty++; else this.items.push({...p, qty:1}); this.render(); UI.toast('Added'); },
            remove(id) { this.items = this.items.filter(i=>i.id!==id); this.render(); },
            total() { return this.items.reduce((s,i)=>s+(i.price*i.qty), 0); },
            render() {
                const html = this.items.length === 0 ? '<div class="text-center opacity-50 p-4">Kosong</div>' : this.items.map(i => `<div class="flex justify-between items-center mb-2"><div><b>${i.name}</b><br><small>${i.qty} x ${UI.fmt(i.price)}</small></div><button class="btn btn-ghost" style="color:red; padding:5px 10px;" onclick="Cart.remove(${i.id})">‚úï</button></div>`).join('');
                if(document.getElementById('cart-list')) document.getElementById('cart-list').innerHTML = html;
                if(document.getElementById('cart-total')) document.getElementById('cart-total').textContent = UI.fmt(this.total());
            },
            clear() { this.items = []; this.render(); }
        };

        const WACart = {
            items: [],
            add(p) { const ex=this.items.find(i=>i.id===p.id); if(ex) ex.qty++; else this.items.push({...p, qty:1}); this.render(); UI.toast('WA Added'); },
            remove(id) { this.items = this.items.filter(i=>i.id!==id); this.render(); },
            total() { return this.items.reduce((s,i)=>s+(i.price*i.qty), 0); },
            render() {
                const html = this.items.length === 0 ? '<div class="text-center opacity-50 p-4">Order WA...</div>' : this.items.map(i => `<div class="flex justify-between items-center mb-2"><div><b>${i.name}</b><br><small>${i.qty} x ${UI.fmt(i.price)}</small></div><button class="btn btn-ghost" style="color:red; padding:5px 10px;" onclick="WACart.remove(${i.id})">‚úï</button></div>`).join('');
                if(document.getElementById('wa-cart-list')) document.getElementById('wa-cart-list').innerHTML = html;
                if(document.getElementById('wa-cart-total')) document.getElementById('wa-cart-total').textContent = UI.fmt(this.total());
            },
            clear() { this.items = []; this.render(); }
        };

        const Views = {
            dashboard() {
                const s = DB.getStats(new Date().toISOString().slice(0, 10));
                return `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;">
                        <div class="card" style="background:var(--accent-grad); color:white;">PENDAPATAN<br><h2>${UI.fmt(s.revenue)}</h2></div>
                        <div class="card">TOTAL BEBAN (HPP+OPS)<br><h2>${UI.fmt(s.hpp + s.exp)}</h2></div>
                    </div>
                    <div class="card mt-4"><h3>Profit Laporan (Hari Ini)</h3><table style="width:100%"><tr><td>Penjualan</td><td align="right">${UI.fmt(s.revenue)}</td></tr><tr><td>Modal Barang & Ops</td><td align="right">(${UI.fmt(s.hpp + s.exp)})</td></tr><tr style="background:#dcfce7"><td><b>LABA BERSIH</b></td><td align="right"><b style="color:green">${UI.fmt(s.netProfit)}</b></td></tr></table></div>`;
            },
            master() {
                return `
                <div class="card">
                    <h3>Tambah Produk Baru</h3>
                    <label class="font-bold">Nama Produk</label><input type="text" id="m-name" class="form-control mb-2" placeholder="Contoh: Rokok Surya 16">
                    <div class="flex gap-2"><div style="flex:1"><label class="font-bold">Harga Jual</label><input type="number" id="m-price" class="form-control"></div><div style="flex:1"><label class="font-bold">HPP/Modal</label><input type="number" id="m-hpp" class="form-control"></div></div>
                    <div class="flex gap-2 mt-2"><div style="flex:1"><label class="font-bold">Stok Awal</label><input type="number" id="m-stock" class="form-control"></div><div style="flex:1"><label class="font-bold">Tipe</label><select id="m-type" class="form-control"><option value="finished">Barang Jual</option><option value="raw">Bahan Mentah</option><option value="non-prod">Kemasan/Plastik</option></select></div></div>
                    <button class="btn btn-primary w-full mt-4" onclick="Views.saveNewProduct()">SIMPAN PRODUK</button>
                </div>`;
            },
            saveNewProduct() {
                const n = document.getElementById('m-name').value, p = parseFloat(document.getElementById('m-price').value), h = parseFloat(document.getElementById('m-hpp').value), s = parseFloat(document.getElementById('m-stock').value), t = document.getElementById('m-type').value;
                if(!n) return UI.toast('Lengkapi nama!');
                DB.data.products.push({ id:Date.now(), name:n, price:p||0, hpp:h||0, stock:s||0, type:t });
                DB.save(); UI.toast('Berhasil!'); Router.go('master');
            },
            pos() {
                const pds = DB.data.products.filter(p=>p.type==='finished');
                return `<div class="pos-layout"><div class="pos-main"><input type="text" class="form-control mb-4" placeholder="Cari..."><div class="pos-grid">${pds.map(p=>`<div class="product" onclick='Cart.add(${JSON.stringify(p)})'><div class="p-img">${p.icon || 'üõçÔ∏è'}</div><div class="p-body"><b>${p.name}</b><br><span style="color:var(--accent)">${UI.fmt(p.price)}</span></div></div>`).join('')}</div></div><div class="cart-panel"><h3>Kasir</h3><div id="cart-list" style="flex:1; overflow-y:auto;"></div><hr><div class="flex justify-between mb-4"><span>Total</span><b id="cart-total" style="font-size:1.5rem; color:var(--accent);">Rp 0</b></div><button class="btn btn-primary w-full" onclick="Views.checkout()">PROSES BAYAR</button></div></div>`;
            },
            online() {
                const pds = DB.data.products.filter(p=>p.type==='finished');
                return `<div class="pos-layout"><div class="pos-main"><input type="text" class="form-control mb-4" placeholder="Cari..."><div class="pos-grid">${pds.map(p=>`<div class="product" onclick='WACart.add(${JSON.stringify(p)})'><div class="p-img">${p.icon || 'üì±'}</div><div class="p-body"><b>${p.name}</b><br><span style="color:var(--success)">${UI.fmt(p.price)}</span></div></div>`).join('')}</div></div><div class="cart-panel"><h3>Order WA</h3><div id="wa-cart-list" style="flex:1; overflow-y:auto;"></div><hr><div class="flex justify-between mb-4"><span>Total</span><b id="wa-cart-total" style="color:var(--success);">Rp 0</b></div><button class="btn btn-success w-full" onclick="Views.checkoutWA()">SIMPAN ORDER</button></div></div>`;
            },
            checkout() {
                const tot = Cart.total(); if(tot === 0) return;
                const nps = DB.data.products.filter(p => p.type === 'non-prod');
                const html = `<div class="text-center mb-4"><h1>${UI.fmt(tot)}</h1></div><label class="font-bold">Kemasan</label><div style="max-height:80px; overflow-y:auto; margin-bottom:15px; border:1px solid var(--border); border-radius:10px; padding:10px;">${nps.map(np => `<label style="display:block;"><input type="checkbox" class="np-checkbox" value="${np.id}"> ${np.name}</label>`).join('')}</div><label class="font-bold">Metode</label><select id="p-method" class="form-control mb-4" onchange="Views.togglePayMode(${tot})"><option value="cash">Tunai</option><option value="transfer">Transfer</option></select><div id="cash-box"><label class="font-bold">Bayar</label><input type="number" id="p-amt" class="form-control" onkeyup="Views.calcChange(${tot})"><div id="p-change" class="mt-2 font-bold text-danger"></div></div>`;
                UI.modal('PEMBAYARAN', html, `<button class="btn btn-ghost" onclick="document.querySelector('.modal-overlay').remove()">Batal</button><button class="btn btn-primary" onclick="Views.finishPay(${tot})">KONFIRMASI</button>`);
            },
            togglePayMode(tot) { const m = document.getElementById('p-method').value; document.getElementById('cash-box').classList.toggle('hidden', m==='transfer'); if(m==='transfer') document.getElementById('p-amt').value = tot; },
            calcChange(tot) { const b = parseFloat(document.getElementById('p-amt').value) || 0; document.getElementById('p-change').textContent = b >= tot ? 'Kembali: ' + UI.fmt(b-tot) : 'Uang Kurang!'; },
            finishPay(tot) {
                const m = document.getElementById('p-method').value, b = parseFloat(document.getElementById('p-amt').value) || (m==='transfer'?tot:0);
                if(b < tot) return UI.toast('Uang Kurang!');
                const npUsed = Array.from(document.querySelectorAll('.np-checkbox:checked')).map(cb => cb.value);
                const trx = DB.addTransaction(Cart.items, tot, b, b-tot, m, npUsed);
                document.querySelector('.modal-overlay').remove(); Cart.clear();
                UI.modal('Berhasil!', `<p>Transaksi Sukses.</p>`, `<button class="btn btn-primary" onclick="Views.printTrx('${trx.id}')">üñ®Ô∏è Cetak Struk</button>`);
            },
            checkoutWA() {
                const nps = DB.data.products.filter(p => p.type === 'non-prod');
                const html = `<input type="text" id="wa-name" class="form-control mb-2" placeholder="Nama"><input type="number" id="wa-phone" class="form-control" placeholder="628..."><label class="font-bold">Kemasan</label><div style="max-height:80px; overflow-y:auto; border:1px solid var(--border); padding:10px;">${nps.map(np => `<label style="display:block;"><input type="checkbox" class="wa-np-checkbox" value="${np.id}"> ${np.name}</label>`).join('')}</div>`;
                UI.modal('ORDER WA', html, `<button class="btn btn-success" onclick="Views.finishWA()">SIMPAN</button>`);
            },
            finishWA() {
                const npUsed = Array.from(document.querySelectorAll('.wa-np-checkbox:checked')).map(cb => cb.value);
                const ord = DB.addWAOrder(document.getElementById('wa-name').value, document.getElementById('wa-phone').value, WACart.items, WACart.total(), npUsed);
                document.querySelector('.modal-overlay').remove(); WACart.clear();
                UI.modal('Disimpan!', `<p>Order Berhasil.</p>`, `<button class="btn btn-primary" onclick="Views.printWA('${ord.id}')">üñ®Ô∏è Cetak</button>`);
            },
            inventory() {
                // FILTER HANYA BARANG FISIK (RAW & NON-PROD) - ANTI NOL
                const items = DB.data.products.filter(p => p.type === 'raw' || p.type === 'non-prod');
                return `
                <div class="flex gap-2 mb-4"><button class="tab-btn active" onclick="UI.switchTab('inv-list')">Daftar Stok</button><button class="tab-btn" onclick="UI.switchTab('inv-update')">Update Manual</button><button class="tab-btn" onclick="UI.switchTab('inv-csv')">Import CSV</button></div>
                <div id="tab-inv-list" class="tab-content"><div class="card"><table><thead><tr><th>Barang</th><th>Stok Sisa</th><th>Nilai Aset</th></tr></thead><tbody>${items.map(p=>`<tr><td>${p.name}</td><td>${p.stock.toFixed(2)}</td><td>${UI.fmt(p.stock*p.hpp)}</td></tr>`).join('')}</tbody></table></div></div>
                <div id="tab-inv-update" class="tab-content hidden"><div class="card"><h3>Update Stok & Catat Pengeluaran</h3><input type="text" id="s-name" class="form-control mb-2" placeholder="Nama Barang (Misal: TELOR)"><div class="flex gap-2"><input type="number" id="s-qty" class="form-control" placeholder="Qty Tambah"><input type="number" id="s-total" class="form-control" placeholder="Total Harga"></div><button class="btn btn-primary w-full mt-4" onclick="Views.saveSupply()">UPDATE & CATAT BIAYA</button></div></div>
                <div id="tab-inv-csv" class="tab-content hidden"><div class="card"><h3>Import via CSV</h3><input type="file" id="csv-file" class="form-control mb-4" accept=".csv"><button class="btn btn-success w-full" onclick="Views.processCSV()">PROSES</button></div></div>`;
            },
            saveSupply() {
                const n = document.getElementById('s-name').value, q = parseInt(document.getElementById('s-qty').value), t = parseFloat(document.getElementById('s-total').value);
                if(!n || isNaN(q)) return;
                let p = DB.data.products.find(x=>x.name.toLowerCase() === n.toLowerCase());
                if(p) p.stock += q; else DB.data.products.push({ id:Date.now(), name:n, price:0, hpp:t/q, stock:q, type:'raw' });
                DB.data.purchases.unshift({ date:new Date().toISOString(), type:'stock-purchase', name:n, total:t });
                DB.save(); UI.toast('Updated!'); Router.go('inventory');
            },
            finance() {
                const s = DB.getStats();
                return `<div class="card"><h3>Laporan Keuangan</h3><table style="width:100%"><tr><td>Total Penjualan</td><td align="right">${UI.fmt(s.revenue)}</td></tr><tr><td>Modal Barang Terjual</td><td align="right">(${UI.fmt(s.hpp)})</td></tr><tr><td>Operasional & Kemasan</td><td align="right">(${UI.fmt(s.exp)})</td></tr><tr style="background:#dcfce7"><td><b>LABA BERSIH</b></td><td align="right"><b style="color:green">${UI.fmt(s.netProfit)}</b></td></tr></table></div>`;
            },
            sales() {
                const all = [...DB.data.transactions.map(t=>({...t, src:'OFFLINE'})), ...DB.data.waOrders.map(w=>({...w, src:'ONLINE'}))].sort((a,b)=>new Date(b.date)-new Date(a.date));
                return `<div class="card"><h3>Log Penjualan</h3><div class="table-responsive"><table><thead><tr><th>Waktu</th><th>Via</th><th>Nama</th><th align="right">Total</th></tr></thead><tbody>${all.map(s=>`<tr><td>${UI.fmtDT(s.date)}</td><td>${s.src}</td><td>${s.customer||'Toko'}</td><td align="right">${UI.fmt(s.total)}</td></tr>`).join('')}</tbody></table></div></div>`;
            },
            expenses() {
                const rows = DB.data.purchases.map(e => `<tr><td>${UI.fmtDT(e.date)}</td><td>${e.type.replace('-usage','').replace('-purchase','').toUpperCase()}</td><td>${e.name || 'Misc'}</td><td align="right" style="color:red">${UI.fmt(e.total)}</td></tr>`).join('');
                return `<div class="card"><h3>Log Pengeluaran (Ops & Kemasan)</h3><div class="table-responsive"><table><thead><tr><th>Waktu</th><th>Kategori</th><th>Detail</th><th align="right">Total</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
            },
            employees() {
                const rows = DB.data.employees.map(e => `<tr><td class="p-4 border-b">${e.name}</td><td class="p-4 border-b">${e.role}</td></tr>`).join('');
                return `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
                    <div class="card"><h3>Tambah Member</h3><input type="text" id="e-name" class="form-control mb-2" placeholder="Nama"><select id="e-role" class="form-control mb-2"><option value="cashier">Kasir</option><option value="admin">Admin</option></select><input type="password" id="e-pin" class="form-control mb-4" placeholder="PIN 4 Digit"><button class="btn btn-primary w-full" onclick="Views.addMember()">DAFTARKAN</button></div>
                    <div class="card"><h3>Ganti PIN Saya</h3><input type="password" id="old-p" class="form-control mb-2" placeholder="PIN Lama"><input type="password" id="new-p" class="form-control mb-4" placeholder="PIN Baru"><button class="btn btn-danger w-full" onclick="Views.changePin()">UPDATE PIN</button></div>
                </div>
                <div class="card mt-4"><h3>Tim</h3><table class="w-full text-left"><thead><tr class="bg-slate-50"><th>Nama</th><th>Jabatan</th></tr></thead><tbody>${rows}</tbody></table><button class="btn btn-danger w-full mt-4" onclick="if(confirm('RESET SEMUA DATA?')){localStorage.removeItem(STORAGE_KEY);location.reload();}">RESET PABRIK</button></div>`;
            },
            addMember() {
                const n = document.getElementById('e-name').value, p = document.getElementById('e-pin').value;
                if(!n || !p) return; DB.data.employees.push({ name:n, role:document.getElementById('e-role').value, pin:p }); DB.save(); UI.toast('Success!'); Router.go('employees');
            },
            changePin() {
                const o = document.getElementById('old-p').value, n = document.getElementById('new-p').value;
                if(o !== Login.user.pin) return UI.toast('PIN Salah!');
                const u = DB.data.employees.find(e=>e.pin === Login.user.pin);
                if(u) { u.pin = n; Login.user.pin = n; DB.save(); UI.toast('Updated!'); Router.go('employees'); }
            },
            printTrx(id) { const t=DB.data.transactions.find(x=>x.id===id); if(t) this.print(t); },
            printWA(id) { const w=DB.data.waOrders.find(x=>x.id===id); if(w) this.print({...w, method:'wa'}); },
            print(d) {
                document.getElementById('r-shop-name').textContent = APP_SETTINGS.shopName;
                document.getElementById('r-shop-addr').textContent = APP_SETTINGS.shopAddress;
                document.getElementById('r-items').innerHTML = d.items.map(i=>`<div class="flex justify-between"><span>${i.name} x${i.qty}</span><span>${UI.fmt(i.price*i.qty)}</span></div>`).join('');
                document.getElementById('r-total').textContent = UI.fmt(d.total);
                setTimeout(() => { window.print(); }, 500);
            }
        };

        window.onload = () => {
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long' });
            DB.init();
            setTimeout(() => { document.getElementById('loading-screen').style.display='none'; document.getElementById('login-screen').style.display='flex'; }, 800);
        };
    </script>
</body>
</html>
