<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UMKM ERP Ultimate - Enterprise v47</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-grad: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            --accent-grad: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            --success-grad: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-grad: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --primary: #0f172a; --accent: #2563eb; --success: #10b981; --danger: #ef4444;
            --bg: #f1f5f9; --surface: #ffffff; --text: #0f172a; --text-muted: #64748b;
            --border: #e2e8f0; --radius-lg: 20px; --radius-md: 12px;
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; }

        .hidden { display: none !important; }
        .flex { display: flex; } .flex-col { flex-direction: column; }
        .items-center { align-items: center; } .justify-between { justify-content: space-between; }
        .font-bold { font-weight: 700; } .text-center { text-align: center; }
        .p-4 { padding: 1.25rem; } .mb-4 { margin-bottom: 1rem; } .w-full { width: 100%; } .gap-2 { gap: 8px; }

        .btn { padding: 12px 20px; border-radius: var(--radius-md); border: none; font-weight: 700; cursor: pointer; transition: 0.3s; display: inline-flex; align-items: center; gap: 10px; font-size: 0.9rem; justify-content: center; color: white; }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--accent-grad); box-shadow: 0 4px 14px rgba(37,99,235,0.3); }
        .btn-success { background: var(--success-grad); box-shadow: 0 4px 14px rgba(16,185,129,0.3); }
        .btn-danger { background: var(--danger-grad); box-shadow: 0 4px 14px rgba(239,68,68,0.3); }
        .btn-ghost { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        
        .card { background: var(--surface); border-radius: var(--radius-lg); border: 1px solid var(--border); padding: 20px; margin-bottom: 16px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .form-control { width:100%; padding:12px; border:2px solid var(--border); border-radius: var(--radius-md); font-size: 0.95rem; background: var(--surface); transition: 0.3s; }

        .tab-btn { padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border); background: white; cursor: pointer; font-weight: 700; color: var(--text-muted); font-size: 0.8rem; }
        .tab-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        .table-responsive { width: 100%; overflow-x: auto; border-radius: var(--radius-md); border: 1px solid var(--border); }
        table { width:100%; border-collapse:collapse; white-space: nowrap; }
        th { text-align:left; padding:12px; background: #f8fafc; color:var(--text-muted); border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        td { padding:12px; border-bottom:1px solid var(--border); font-size: 0.85rem; }

        #app-main { display:none; height:100vh; width: 100%; overflow: hidden; }
        aside { width: 260px; background: var(--primary-grad); display:flex; flex-direction:column; z-index:1000; transition: 0.4s; }
        .nav-item { padding:12px 20px; border-radius: var(--radius-md); margin: 4px 12px; cursor:pointer; display:flex; align-items:center; gap:14px; color: rgba(255,255,255,0.7); font-weight: 500; font-size: 0.9rem; }
        .nav-item.active { background: var(--accent-grad); color: white; }
        
        main { flex:1; display:flex; flex-direction:column; overflow:hidden; background: var(--bg); position: relative; }
        header { height:70px; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border-bottom:1px solid var(--border); display:flex; align-items:center; padding:0 20px; justify-content:space-between; flex-shrink: 0; }
        .content { flex:1; overflow-y:auto; padding:20px; }

        .pos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 12px; overflow-y: auto; padding-bottom: 20px; }
        .product { border: 1px solid var(--border); border-radius: var(--radius-lg); overflow:hidden; cursor:pointer; background:white; transition: 0.2s; }
        .p-img { height:100px; background:#f1f5f9; object-fit:cover; width:100%; border-bottom:1px solid var(--border); }

        .cart-panel { width: 320px; background: white; border-radius: var(--radius-lg); border: 1px solid var(--border); display: flex; flex-direction: column; height: 100%; padding: 20px; box-shadow: var(--shadow-md); }

        .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.7); display:flex; align-items:center; justify-content:center; z-index:5000; backdrop-filter:blur(8px); padding:20px; }
        .toast { position:fixed; bottom:40px; left:50%; transform:translateX(-50%); background: var(--primary); color:white; padding:15px 30px; border-radius:50px; z-index:99999; font-weight: 600; opacity:0; transition: 0.4s; pointer-events:none; }
        .toast.show { opacity:1; }

        #loading-screen { position: fixed; inset:0; background: var(--primary-grad); z-index:99999; display:flex; flex-direction:column; justify-content:center; align-items:center; color:white; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.1); border-top-color: #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }

        @media print {
            body * { visibility: hidden !important; }
            #thermal-receipt, #thermal-receipt * { visibility: visible !important; }
            #thermal-receipt { position: absolute; left: 0; top: 0; width: 58mm; display: block !important; padding: 5mm; background: white; color: black; font-family: 'Roboto Mono', monospace; font-size: 10px; }
        }
        @media (max-width: 1024px) {
            .cart-panel { display: none; }
            aside { position: fixed; transform: translateX(-100%); height: 100%; width: 260px; }
            aside.open { transform: translateX(0); }
        }
    </style>
</head>
<body>

    <div id="loading-screen"><div class="spinner"></div><h2 style="margin-top:20px;">UMKM ERP ULTIMATE</h2></div>

    <div id="login-screen" style="position: fixed; inset:0; background:var(--bg); z-index:9998; display:none; flex-direction:column; justify-content:center; align-items:center;">
        <div class="card" style="width: 90%; max-width: 400px; text-align: center; padding: 40px;">
            <div style="margin-bottom: 20px;"><img src="https://cdn-icons-png.flaticon.com/512/6195/6195699.png" style="width:60px;"></div>
            <h2 class="mb-4">Login Sistem</h2>
            <div style="background:#f1f5f9; padding:20px; border-radius:20px; font-family:'Roboto Mono'; font-size:2.5rem; color:var(--accent); margin-bottom:25px; border:2px solid var(--border); height:85px; display:flex; align-items:center; justify-content:center;" id="pin-display"></div>
            <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                <button class="btn btn-ghost" onclick="Login.input(1)">1</button><button class="btn btn-ghost" onclick="Login.input(2)">2</button><button class="btn btn-ghost" onclick="Login.input(3)">3</button>
                <button class="btn btn-ghost" onclick="Login.input(4)">4</button><button class="btn btn-ghost" onclick="Login.input(5)">5</button><button class="btn btn-ghost" onclick="Login.input(6)">6</button>
                <button class="btn btn-ghost" onclick="Login.input(7)">7</button><button class="btn btn-ghost" onclick="Login.input(8)">8</button><button class="btn btn-ghost" onclick="Login.input(9)">9</button>
                <button class="btn btn-danger" onclick="Login.clear()">C</button><button class="btn btn-ghost" onclick="Login.input(0)">0</button>
                <button class="btn btn-primary" onclick="Login.submit()">OK</button>
            </div>
        </div>
    </div>

    <div id="app-main" class="flex">
        <aside id="sidebar">
            <div style="padding:25px; text-align:center;"><h2 style="color:white; font-weight:800; margin:0;">UMKM ERP.</h2></div>
            <nav style="flex:1; overflow-y:auto;">
                <a class="nav-item hidden" id="nav-dashboard" onclick="Router.go('dashboard')"><span>üìä</span> <span>Dashboard</span></a>
                <a class="nav-item hidden" id="nav-master" onclick="Router.go('master')"><span>‚öôÔ∏è</span> <span>Menu & Resep</span></a>
                <a class="nav-item" id="nav-pos" onclick="Router.go('pos')"><span>üõí</span> <span>Kasir Toko</span></a>
                <a class="nav-item" id="nav-online" onclick="Router.go('online')"><span>üì±</span> <span>Order WA</span></a>
                <a class="nav-item hidden" id="nav-sales" onclick="Router.go('sales')"><span>üìà</span> <span>Log Penjualan</span></a>
                <a class="nav-item hidden" id="nav-expenses" onclick="Router.go('expenses')"><span>üìâ</span> <span>Log Pengeluaran</span></a>
                <a class="nav-item" id="nav-supply" onclick="Router.go('supply')"><span>üöö</span> <span>Operasional</span></a>
                <a class="nav-item hidden" id="nav-inventory" onclick="Router.go('inventory')"><span>üì¶</span> <span>Stok Barang</span></a>
                <a class="nav-item hidden" id="nav-finance" onclick="Router.go('finance')"><span>üìÑ</span> <span>Laporan Keuangan</span></a>
                <a class="nav-item hidden" id="nav-employees" onclick="Router.go('employees')"><span>üë•</span> <span>Tim</span></a>
            </nav>
            <div style="padding:20px;"><button class="btn btn-danger w-full" onclick="location.reload()">Log Out</button></div>
        </aside>

        <main>
            <header>
                <button class="btn btn-ghost" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
                <div id="page-title" class="font-bold">DASHBOARD</div>
                <div id="date-display" class="hidden md:block"></div>
            </header>
            <div id="content" class="content"></div>
        </main>
    </div>

    <div id="thermal-receipt" style="display:none;">
        <div style="text-align:center; margin-bottom:10px;"><b id="r-shop-name">UMKM ELITE POS</b><br><span id="r-shop-addr" style="font-size:9px;">Digital District No. 101</span></div>
        <div style="border-top:1px dashed black; margin:5px 0;"></div>
        <div id="r-items"></div>
        <div style="border-top:1px dashed black; margin:5px 0;"></div>
        <div class="flex justify-between" style="font-weight:bold;"><span>TOTAL</span><span id="r-total"></span></div>
        <div style="text-align:center; margin-top:15px; font-size:9px;">TERIMA KASIH</div>
    </div>

    <div id="toast-msg" class="toast"></div>

    <script>
        const APP_SETTINGS = { shopName: "UMKM ELITE POS", shopAddress: "Digital District No. 101" };

        const DB = {
            data: { products: [], transactions: [], purchases: [], employees: [], waOrders: [] },
            init() {
                const store = localStorage.getItem('umkm_erp_v47');
                if(store) this.data = JSON.parse(store);
                else {
                    this.data.products = [ 
                        { id:101, name:'Beras', price:0, hpp:12000, stock:50, type:'raw' },
                        { id:102, name:'Teh Kering', price:0, hpp:5000, stock:20, type:'raw' },
                        { id:103, name:'Gula Pasir', price:0, hpp:15000, stock:10, type:'raw' },
                        { id:104, name:'Kerupuk Mentah', price:0, hpp:25000, stock:5, type:'raw' },
                        { id:201, name:'Plastik Kresek', price:0, hpp:500, stock:100, type:'non-prod' },
                        { id:1, name:'Nasi Goreng', price:20000, hpp:8000, stock:0, type:'finished', recipe: [{name:'Beras', qty:0.2}] },
                        { id:2, name:'Teh Manis', price:5000, hpp:2000, stock:0, type:'finished', recipe: [{name:'Teh Kering', qty:0.01}, {name:'Gula Pasir', qty:0.02}] },
                        { id:3, name:'Kerupuk', price:2000, hpp:1000, stock:0, type:'finished', recipe: [{name:'Kerupuk Mentah', qty:0.05}] }
                    ];
                    this.data.employees = [ { pin:'1234', name:'Owner', role:'admin' }, { pin:'0000', name:'Kasir', role:'cashier' } ];
                    this.save();
                }
            },
            save() { localStorage.setItem('umkm_erp_v47', JSON.stringify(this.data)); },
            addTransaction(items, total, pay, change, method, npUsed = []) {
                const trx = { id:'TRX'+Date.now().toString().slice(-6), date:new Date().toISOString(), items, total, pay, change, method, npUsed };
                this.data.transactions.unshift(trx);
                this.processStockAndExpense(items, npUsed);
                this.save(); return trx;
            },
            addWAOrder(customer, phone, items, total, npUsed = []) {
                const ord = { id:'WA'+Date.now().toString().slice(-6), date:new Date().toISOString(), customer, phone, items, total, npUsed, status:'completed' };
                this.data.waOrders.unshift(ord);
                this.processStockAndExpense(items, npUsed);
                this.save(); return ord;
            },
            processStockAndExpense(items, npUsed) {
                items.forEach(sold => {
                    const p = this.data.products.find(x => x.id === sold.id);
                    if (p && p.recipe) {
                        p.recipe.forEach(ing => {
                            const raw = this.data.products.find(r => r.name.toLowerCase() === ing.name.toLowerCase());
                            if (raw) raw.stock -= (ing.qty * sold.qty);
                        });
                    }
                });
                npUsed.forEach(id => {
                    const np = this.data.products.find(x => x.id == id);
                    if (np) {
                        np.stock -= 1;
                        this.data.purchases.unshift({ 
                            date: new Date().toISOString(), 
                            type: 'non-prod-usage', 
                            name: np.name, 
                            total: np.hpp, 
                            isUsage: true 
                        });
                    }
                });
            },
            getStats(filterDate = null) {
                let trs = this.data.transactions, was = this.data.waOrders, purs = this.data.purchases;
                if (filterDate) {
                    trs = trs.filter(t => t.date.startsWith(filterDate));
                    was = was.filter(w => w.date.startsWith(filterDate));
                    purs = purs.filter(p => p.date.startsWith(filterDate));
                }
                const rev = trs.reduce((s,t)=>s+t.total,0) + was.reduce((s,w)=>s+w.total,0);
                const hppRecipe = trs.reduce((s,t)=>s+t.items.reduce((a,i)=>a+(i.hpp*i.qty),0),0) + was.reduce((s,w)=>s+w.items.reduce((a,i)=>a+(i.hpp*i.qty),0),0);
                const expNonProd = purs.filter(p=>p.type==='non-prod-usage').reduce((s,p)=>s+p.total, 0);
                const expMisc = purs.filter(p=>p.type==='misc').reduce((s,p)=>s+p.total, 0);
                const expTotal = hppRecipe + expNonProd + expMisc;
                return { revenue: rev, hppRecipe, expNonProd, expMisc, expTotal, netProfit: rev - expTotal };
            }
        };

        const Login = {
            pin: '',
            input(n) { if(this.pin.length<4) { this.pin+=n; this.update(); } },
            clear() { this.pin=''; this.update(); },
            update() { document.getElementById('pin-display').textContent='‚Ä¢'.repeat(this.pin.length); },
            submit() {
                const u = DB.data.employees.find(e=>e.pin===this.pin);
                if(u) { 
                    this.user=u; document.getElementById('login-screen').style.display='none'; document.getElementById('app-main').style.display='flex'; 
                    if(u.role === 'admin') document.querySelectorAll('.nav-item.hidden').forEach(el=>el.classList.remove('hidden'));
                    Router.go(u.role==='admin'?'dashboard':'pos');
                } else { UI.toast('PIN Salah!'); this.clear(); }
            }
        };

        const Router = {
            go(view) {
                const isOwnerOnly = ['dashboard','finance','employees','sales','expenses','inventory','master'].includes(view);
                if(Login.user?.role === 'cashier' && isOwnerOnly) return UI.toast('Akses Ditolak!');
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                const navItem = document.getElementById('nav-'+view); if(navItem) navItem.classList.add('active');
                document.getElementById('sidebar').classList.remove('open');
                
                // Perbaikan Title (menyesuaikan sidebar)
                const titles = { 'supply': 'OPERASIONAL', 'inventory': 'STOK BARANG' };
                document.getElementById('page-title').textContent = titles[view] || view.toUpperCase();
                
                const content = document.getElementById('content');
                if(Views[view]) content.innerHTML = Views[view]();
                if(view === 'pos') Cart.render(); if(view === 'online') WACart.render();
            }
        };

        const UI = {
            fmt(n) { return 'Rp ' + (n||0).toLocaleString('id-ID'); },
            fmtDT(iso) { const d = new Date(iso); return d.toLocaleDateString('id-ID', { day:'2-digit', month:'short' }) + ' ' + d.toLocaleTimeString('id-ID', { hour:'2-digit', minute:'2-digit' }); },
            toast(msg) { const t=document.getElementById('toast-msg'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 2500); },
            modal(title, html, btn) {
                const m=document.createElement('div'); m.className = 'modal-overlay';
                m.innerHTML = `<div class="card" style="width:100%; max-width:420px;"><h2 class="mb-4">${title}</h2>${html}<div class="flex gap-4 mt-6 justify-end">${btn}</div></div>`;
                document.body.appendChild(m);
                m.onclick = e => { if(e.target===m) m.remove(); };
            },
            switchTab(tab, el) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                const target = document.getElementById('tab-' + tab);
                if (target) target.classList.remove('hidden');
                if (el) el.classList.add('active');
            }
        };

        const Cart = {
            items: [],
            add(p) { const ex=this.items.find(i=>i.id===p.id); if(ex) ex.qty++; else this.items.push({...p, qty:1}); this.render(); UI.toast('Ditambah'); },
            remove(id) { this.items = this.items.filter(i=>i.id!==id); this.render(); },
            total() { return this.items.reduce((s,i)=>s+(i.price*i.qty), 0); },
            render() {
                const html = this.items.length === 0 ? '<div class="text-center opacity-50 p-4">Kosong</div>' : this.items.map(i => `<div class="flex justify-between items-center mb-2"><div><b>${i.name}</b><br><small>${i.qty} x ${UI.fmt(i.price)}</small></div><button class="btn btn-ghost" style="color:red; padding:5px 10px;" onclick="Cart.remove(${i.id})">‚úï</button></div>`).join('');
                if(document.getElementById('cart-list')) document.getElementById('cart-list').innerHTML = html;
                if(document.getElementById('cart-total')) document.getElementById('cart-total').textContent = UI.fmt(this.total());
            },
            clear() { this.items = []; this.render(); }
        };

        const WACart = {
            items: [],
            add(p) { const ex=this.items.find(i=>i.id===p.id); if(ex) ex.qty++; else this.items.push({...p, qty:1}); this.render(); UI.toast('WA Ditambah'); },
            remove(id) { this.items = this.items.filter(i=>i.id!==id); this.render(); },
            total() { return this.items.reduce((s,i)=>s+(i.price*i.qty), 0); },
            render() {
                const html = this.items.length === 0 ? '<div class="text-center opacity-50 p-4">Order WA...</div>' : this.items.map(i => `<div class="flex justify-between items-center mb-2"><div><b>${i.name}</b><br><small>${i.qty} x ${UI.fmt(i.price)}</small></div><button class="btn btn-ghost" style="color:red; padding:5px 10px;" onclick="WACart.remove(${i.id})">‚úï</button></div>`).join('');
                if(document.getElementById('wa-cart-list')) document.getElementById('wa-cart-list').innerHTML = html;
                if(document.getElementById('wa-cart-total')) document.getElementById('wa-cart-total').textContent = UI.fmt(this.total());
            },
            clear() { this.items = []; this.render(); }
        };

        const Views = {
            dashboard() {
                const s = DB.getStats(new Date().toISOString().slice(0, 10));
                return `<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:20px;"><div class="card" style="background:var(--accent-grad); color:white;">PENDAPATAN<br><h2>${UI.fmt(s.revenue)}</h2></div><div class="card">TOTAL BEBAN (HPP+OPS)<br><h2>${UI.fmt(s.expTotal)}</h2></div></div><div class="card mt-4"><h3>Profit Realtime (Hari Ini)</h3><table style="width:100%"><tr><td>Penjualan</td><td align="right">${UI.fmt(s.revenue)}</td></tr><tr><td>Beban Keseluruhan</td><td align="right">(${UI.fmt(s.expTotal)})</td></tr><tr style="background:#dcfce7"><td><b>LABA BERSIH</b></td><td align="right"><b style="color:green">${UI.fmt(s.netProfit)}</b></td></tr></table></div>`;
            },
            master() {
                return `<div class="card"><h3>Tambah Menu & Resep Manual</h3><label class="font-bold">Nama Menu</label><input type="text" id="m-name" class="form-control mb-2" placeholder="Nasi Goreng"><div class="flex gap-2"><div style="flex:1"><label class="font-bold">Harga Jual</label><input type="number" id="m-price" class="form-control"></div><div style="flex:1"><label class="font-bold">Estimasi Modal</label><input type="number" id="m-hpp" class="form-control"></div></div><div style="background:#f8fafc; padding:15px; border-radius:10px; margin:15px 0;"><b>Setup Resep (Ketik Nama Bahan)</b><br><div class="flex gap-2 mt-2"><input type="text" id="r-ing-name" class="form-control" style="flex:2" placeholder="Ketik: Beras"><input type="number" id="r-qty" class="form-control" style="flex:1" placeholder="Gram"><button class="btn btn-ghost" onclick="Views.addIngredientToTemp()">+</button></div><ul id="temp-recipe-list" style="font-size:12px; margin-top:10px;"></ul></div><button class="btn btn-primary w-full" onclick="Views.saveNewProductWithRecipe()">SIMPAN MENU</button></div>`;
            },
            tempRecipe: [],
            addIngredientToTemp() {
                const n = document.getElementById('r-ing-name').value, q = parseFloat(document.getElementById('r-qty').value);
                if(!n || !q) return; this.tempRecipe.push({name: n, qty: q});
                document.getElementById('temp-recipe-list').innerHTML += `<li>${n} : ${q} gram</li>`;
                document.getElementById('r-ing-name').value = ''; document.getElementById('r-qty').value = '';
            },
            saveNewProductWithRecipe() {
                const n = document.getElementById('m-name').value, p = parseFloat(document.getElementById('m-price').value), h = parseFloat(document.getElementById('m-hpp').value);
                if(!n || !p) return UI.toast('Lengkapi data!');
                this.tempRecipe.forEach(ing => {
                    const exists = DB.data.products.find(x => x.name.toLowerCase() === ing.name.toLowerCase());
                    if (!exists) DB.data.products.push({ id: Date.now()+Math.random(), name: ing.name, price: 0, hpp: 0, stock: 0, type: 'raw' });
                });
                DB.data.products.push({ id:Date.now(), name:n, price:p, hpp:h, stock:0, type:'finished', recipe: [...this.tempRecipe] });
                DB.save(); UI.toast('Success!'); this.tempRecipe = []; Router.go('master');
            },
            pos() {
                const pds = DB.data.products.filter(p=>p.type==='finished');
                return `<div class="pos-layout"><div class="pos-main"><input type="text" class="form-control mb-4" placeholder="Cari menu..."><div class="pos-grid">${pds.map(p=>`<div class="product" onclick='Cart.add(${JSON.stringify(p)})'><img src="https://picsum.photos/seed/${p.id}/300/200" class="p-img"><div class="p-body"><b>${p.name}</b><br><span style="color:var(--accent)">${UI.fmt(p.price)}</span></div></div>`).join('')}</div></div><div class="cart-panel"><h3>Keranjang</h3><div id="cart-list" style="flex:1; overflow-y:auto;"></div><hr><div class="flex justify-between mb-4"><span>Total</span><b id="cart-total" style="font-size:1.5rem; color:var(--accent);">Rp 0</b></div><button class="btn btn-primary w-full" onclick="Views.checkout()">BAYAR</button></div></div>`;
            },
            online() {
                const pds = DB.data.products.filter(p=>p.type==='finished');
                return `<div class="pos-layout"><div class="pos-main"><input type="text" class="form-control mb-4" placeholder="Cari..."><div class="pos-grid">${pds.map(p=>`<div class="product" onclick='WACart.add(${JSON.stringify(p)})'><img src="https://picsum.photos/seed/${p.id}/300/200" class="p-img"><div class="p-body"><b>${p.name}</b><br><span style="color:var(--success)">${UI.fmt(p.price)}</span></div></div>`).join('')}</div></div><div class="cart-panel"><h3>Order WA</h3><div id="wa-cart-list" style="flex:1; overflow-y:auto;"></div><hr><div class="flex justify-between mb-4"><span>Total</span><b id="wa-cart-total" style="color:var(--success);">Rp 0</b></div><button class="btn btn-success w-full" onclick="Views.checkoutWA()">SIMPAN ORDER</button></div></div>`;
            },
            checkout() {
                const tot = Cart.total(); if(tot === 0) return;
                const nps = DB.data.products.filter(p => p.type === 'non-prod');
                const html = `<div class="text-center mb-4"><h1>${UI.fmt(tot)}</h1></div><label class="font-bold">Additional</label><div style="max-height:100px; overflow-y:auto; border:1px solid var(--border); border-radius:10px; padding:10px;">${nps.map(np => `<label style="display:block;"><input type="checkbox" class="np-checkbox" value="${np.id}"> ${np.name}</label>`).join('')}</div><label class="font-bold">Metode</label><select id="p-method" class="form-control mb-4" onchange="Views.togglePayMode(${tot})"><option value="cash">Tunai</option><option value="transfer">Transfer</option></select><div id="cash-box"><label class="font-bold">Bayar</label><input type="number" id="p-amt" class="form-control" onkeyup="Views.calcChange(${tot})"><div id="p-change" class="mt-2 font-bold text-danger"></div></div>`;
                UI.modal('PEMBAYARAN', html, `<button class="btn btn-ghost" onclick="document.querySelector('.modal-overlay').remove()">Batal</button><button class="btn btn-primary" onclick="Views.finishPay(${tot})">KONFIRMASI</button>`);
            },
            togglePayMode(tot) { const m = document.getElementById('p-method').value; document.getElementById('cash-box').classList.toggle('hidden', m==='transfer'); if(m==='transfer') document.getElementById('p-amt').value = tot; },
            calcChange(tot) { const b = parseFloat(document.getElementById('p-amt').value) || 0; document.getElementById('p-change').textContent = b >= tot ? 'Kembali: ' + UI.fmt(b-tot) : 'Uang Kurang!'; },
            finishPay(tot) {
                const m = document.getElementById('p-method').value, b = parseFloat(document.getElementById('p-amt').value) || (m==='transfer'?tot:0);
                if(b < tot) return UI.toast('Uang Kurang!');
                const npUsed = Array.from(document.querySelectorAll('.np-checkbox:checked')).map(cb => cb.value);
                const trx = DB.addTransaction(Cart.items, tot, b, b-tot, m, npUsed);
                document.querySelector('.modal-overlay').remove(); Cart.clear();
                UI.modal('Berhasil!', `<p>Transaksi Sukses.</p>`, `<button class="btn btn-primary" onclick="Views.printTrx('${trx.id}')">üñ®Ô∏è Cetak</button>`);
            },
            checkoutWA() {
                const nps = DB.data.products.filter(p => p.type === 'non-prod');
                const html = `<input type="text" id="wa-name" class="form-control mb-2" placeholder="Nama"><input type="number" id="wa-phone" class="form-control mb-4" placeholder="628..."><label class="font-bold">Additional</label><div style="max-height:100px; overflow-y:auto; border:1px solid var(--border); padding:10px;">${nps.map(np => `<label style="display:block;"><input type="checkbox" class="wa-np-checkbox" value="${np.id}"> ${np.name}</label>`).join('')}</div>`;
                UI.modal('ORDER WA', html, `<button class="btn btn-success" onclick="Views.finishWA()">SIMPAN</button>`);
            },
            finishWA() {
                const npUsed = Array.from(document.querySelectorAll('.wa-np-checkbox:checked')).map(cb => cb.value);
                const ord = DB.addWAOrder(document.getElementById('wa-name').value, document.getElementById('wa-phone').value, WACart.items, WACart.total(), npUsed);
                document.querySelector('.modal-overlay').remove(); WACart.clear();
                UI.modal('Disimpan!', `<p>Order Berhasil.</p>`, `<button class="btn btn-primary" onclick="Views.printWA('${ord.id}')">üñ®Ô∏è Cetak</button>`);
            },
            inventory() {
                const raw = DB.data.products.filter(p=>p.type==='raw');
                const nonProd = DB.data.products.filter(p=>p.type==='non-prod');
                return `<div class="flex gap-2 mb-4"><button class="tab-btn active" onclick="window.UI.switchTab('inv-list-prod', this)">Stok Produksi</button><button class="tab-btn" onclick="window.UI.switchTab('inv-non-prod', this)">Non Produksi</button><button class="tab-btn" onclick="window.UI.switchTab('inv-update', this)">Update Stok</button></div><div id="tab-inv-list-prod" class="tab-content"><div class="card"><table><thead><tr><th>Bahan</th><th>Stok</th></tr></thead><tbody>${raw.map(p=>`<tr><td>${p.name}</td><td>${p.stock.toFixed(2)}</td></tr>`).join('')}</tbody></table></div></div><div id="tab-inv-non-prod" class="tab-content hidden"><div class="card"><table><thead><tr><th>Barang</th><th>Stok</th></tr></thead><tbody>${nonProd.map(p=>`<tr><td>${p.name}</td><td>${p.stock}</td></tr>`).join('')}</tbody></table></div></div><div id="tab-inv-update" class="tab-content hidden"><div class="card"><h3>Update Stok</h3><input type="text" id="s-name" class="form-control mb-2" placeholder="Nama Bahan"><input type="number" id="s-qty" class="form-control mb-4" placeholder="Jumlah"><button class="btn btn-primary w-full" onclick="window.Views.saveSupply()">UPDATE</button></div></div>`;
            },
            saveSupply() {
                const n = document.getElementById('s-name').value, q = parseInt(document.getElementById('s-qty').value);
                if(!n || isNaN(q)) return;
                let p = DB.data.products.find(x=>x.name.toLowerCase() === n.toLowerCase());
                if(p) p.stock += q; else DB.data.products.push({ id:Date.now(), name:n, price:0, hpp:0, stock:q, type:'raw' });
                DB.save(); UI.toast('Updated!'); Router.go('inventory');
            },
            supply() { return `<div class="card"><h3>Catat Biaya Operasional (Misc)</h3><input type="text" id="ops-name" class="form-control mb-2" placeholder="Listrik / Gaji"><input type="number" id="ops-cost" class="form-control mb-4" placeholder="Rp..."><button class="btn btn-danger w-full" onclick="window.Views.saveOps()">SIMPAN BEBAN</button></div>`; },
            saveOps() { 
                DB.data.purchases.unshift({ date:new Date().toISOString(), type:'misc', name:document.getElementById('ops-name').value, total:parseFloat(document.getElementById('ops-cost').value) });
                DB.save(); UI.toast('Beban Dicatat!'); Router.go('dashboard'); 
            },
            finance() {
                const s = DB.getStats();
                return `<div class="card"><h3>Laporan Keuangan</h3><table style="width:100%"><tr><td>Penjualan</td><td align="right">${UI.fmt(s.revenue)}</td></tr><tr><td>Beban Total</td><td align="right">(${UI.fmt(s.expTotal)})</td></tr><tr style="background:#dcfce7"><td><b>LABA BERSIH</b></td><td align="right"><b>${UI.fmt(s.netProfit)}</b></td></tr></table></div>`;
            },
            sales() {
                const all = [...DB.data.transactions.map(t=>({...t, src:'OFFLINE'})), ...DB.data.waOrders.map(w=>({...w, src:'ONLINE'}))].sort((a,b)=>new Date(b.date)-new Date(a.date));
                return `<div class="card"><h3>Log Penjualan</h3><div class="table-responsive"><table><thead><tr><th>Waktu</th><th>Via</th><th>Nama</th><th align="right">Total</th></tr></thead><tbody>${all.map(s=>`<tr><td>${UI.fmtDT(s.date)}</td><td>${s.src}</td><td>${s.customer||'Toko'}</td><td align="right">${UI.fmt(s.total)}</td></tr>`).join('')}</tbody></table></div></div>`;
            }
        };

        // EXPLICIT GLOBAL SCOPING FOR PRODUCTION (NETLIFY)
        window.DB = DB;
        window.UI = UI;
        window.Views = Views;
        window.Router = Router;
        window.Cart = Cart;
        window.WACart = WACart;
        window.Login = Login;

        window.onload = () => {
            document.getElementById('date-display').textContent = new Date().toLocaleDateString('id-ID', { weekday:'long', day:'numeric', month:'long' });
            DB.init();
            setTimeout(() => { 
                document.getElementById('loading-screen').style.display='none'; 
                document.getElementById('login-screen').style.display='flex'; 
            }, 800);
        };
    </script>
</body>
</html>
